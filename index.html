<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS - Motor Shop Full System</title>
<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{margin:0;background:#f4f6f8;color:#222}
header{background:#0b79d0;color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
header h1{margin:0;font-size:18px}
.controls{display:flex;gap:8px;align-items:center}
.controls button,input{padding:6px 8px;border-radius:6px;border:0;background:#fff;color:#000}
main{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
label{display:block;margin-bottom:8px}
input,select{width:100%;padding:8px;margin-top:4px;border:1px solid #ddd;border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:8px}
thead th{background:#eef4fb;padding:8px;border-bottom:1px solid #ddd}
tbody td{padding:8px;border-bottom:1px solid #eee}
button.primary{cursor:pointer;padding:8px 10px;border-radius:6px;border:0;background:#0b79d0;color:white}
button.danger{background:#d03b3b;color:white;padding:6px 8px;border:0;border-radius:6px}
.low{color:red;font-weight:bold}
.row{display:flex;gap:8px}
.small{width:120px}
.infoBox{margin-top:12px;padding:10px;border-radius:6px;background:#fbfbfd;border:1px solid #eef4fb}
@media(max-width:900px){main{grid-template-columns:1fr}}
</style>
</head>

<body>
<header>
  <h1>POS - Motor Shop System</h1>
  <div class="controls">
    <button id="exportBtn">Export Backup</button>
    <input id="importFile" type="file" style="display:none" />
    <button id="importBtn">Import Backup</button>
    <button id="clearAll">Clear All (dev)</button>
  </div>
</header>

<main>

<!-- LEFT SIDE -->
<section class="card">
  <h3>Add / Edit Item</h3>

  <form id="itemForm">
    <input type="hidden" id="itemId" />
    <label>Name<input id="name" required /></label>
    <label>Buying Price<input type="number" id="buy" step="0.01" required /></label>
    <label>Selling Price<input type="number" id="sell" step="0.01" required /></label>
    <label>Quantity<input type="number" id="qty" step="1" required /></label>
    <label>Location<input id="loc" /></label>

    <div class="row" style="margin-top:8px">
      <button class="primary" type="submit">Save Item</button>
      <button type="button" id="cancel">Cancel</button>
    </div>
  </form>

  <h3 style="margin-top:14px">Items</h3>
  <input id="search" placeholder="Search item..." />

  <div id="searchDetails" class="infoBox" style="display:none"></div>

  <table>
    <thead>
      <tr><th>Name</th><th>Buy</th><th>Sell</th><th>Profit</th><th>Qty</th><th>Loc</th><th>Actions</th></tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <div style="margin-top:12px" class="infoBox">
    <b>Total Inventory Value:</b> ₱<span id="invValue">0.00</span>
  </div>
</section>
<!-- RIGHT SIDE -->
<section class="card">
  <h3>Record Sale</h3>

  <form id="saleForm">
    <label>Item<select id="saleItem"></select></label>
    <label>Quantity<input type="number" id="saleQty" min="1" value="1" required /></label>
    <label>Date<input type="date" id="saleDate" required /></label>
    <div style="margin-top:8px"><button class="primary" type="submit">Add Sale</button></div>
  </form>

  <h3 style="margin-top:12px">Sales</h3>

  <table>
    <thead>
      <tr><th>Date</th><th>Item</th><th>Qty</th><th>Total</th><th>Profit</th><th>Actions</th></tr>
    </thead>
    <tbody id="sales"></tbody>
  </table>

  <h3 style="margin-top:18px">Daily / Monthly Summary</h3>
  <div class="infoBox">
    <div>Sales Profit Today: ₱<span id="salesProfitToday">0.00</span></div>
    <div>Expenses Today: ₱<span id="expensesToday">0.00</span></div>
    <div><b>Net Profit Today: ₱<span id="netToday">0.00</span></b></div>
    <hr />
    <div>Sales Profit This Month: ₱<span id="salesProfitMonth">0.00</span></div>
    <div>Expenses This Month: ₱<span id="expensesMonth">0.00</span></div>
    <div><b>Net Profit This Month: ₱<span id="netMonth">0.00</span></b></div>
  </div>

  <h3 style="margin-top:18px">Expenses (with Category)</h3>

  <form id="expenseForm">
    <label>Expense Name<input id="expName" required /></label>
    <label>Amount<input type="number" id="expAmount" step="0.01" required /></label>

    <label>Category
      <select id="expCategory">
        <option value="Fuel">Fuel</option>
        <option value="Food">Food</option>
        <option value="Delivery">Delivery</option>
        <option value="Supplies">Supplies</option>
        <option value="Other">Other</option>
      </select>
    </label>

    <label>Date<input type="date" id="expDate" required /></label>

    <div style="margin-top:8px">
      <button class="primary" type="submit">Add Expense</button>
    </div>
  </form>

  <h4 style="margin-top:12px">Expenses List</h4>

  <table>
    <thead>
      <tr><th>Date</th><th>Name</th><th>Category</th><th>Amount</th><th>Action</th></tr>
    </thead>
    <tbody id="expenses"></tbody>
  </table>
</section>

</main>

<!-- JAVASCRIPT START -->
<script>
/* Storage keys */
const LS_ITEMS = 'pos_items_v_exp';
const LS_SALES = 'pos_sales_v_exp';
const LS_EXP = 'pos_expo
  <!-- RIGHT SIDE -->
<section class="card">
  <h3>Record Sale</h3>

  <form id="saleForm">
    <label>Item<select id="saleItem"></select></label>
    <label>Quantity<input type="number" id="saleQty" min="1" value="1" required /></label>
    <label>Date<input type="date" id="saleDate" required /></label>
    <div style="margin-top:8px"><button class="primary" type="submit">Add Sale</button></div>
  </form>

  <h3 style="margin-top:12px">Sales</h3>

  <table>
    <thead>
      <tr><th>Date</th><th>Item</th><th>Qty</th><th>Total</th><th>Profit</th><th>Actions</th></tr>
    </thead>
    <tbody id="sales"></tbody>
  </table>

  <h3 style="margin-top:18px">Daily / Monthly Summary</h3>
  <div class="infoBox">
    <div>Sales Profit Today: ₱<span id="salesProfitToday">0.00</span></div>
    <div>Expenses Today: ₱<span id="expensesToday">0.00</span></div>
    <div><b>Net Profit Today: ₱<span id="netToday">0.00</span></b></div>
    <hr />
    <div>Sales Profit This Month: ₱<span id="salesProfitMonth">0.00</span></div>
    <div>Expenses This Month: ₱<span id="expensesMonth">0.00</span></div>
    <div><b>Net Profit This Month: ₱<span id="netMonth">0.00</span></b></div>
  </div>

  <h3 style="margin-top:18px">Expenses (with Category)</h3>

  <form id="expenseForm">
    <label>Expense Name<input id="expName" required /></label>
    <label>Amount<input type="number" id="expAmount" step="0.01" required /></label>

    <label>Category
      <select id="expCategory">
        <option value="Fuel">Fuel</option>
        <option value="Food">Food</option>
        <option value="Delivery">Delivery</option>
        <option value="Supplies">Supplies</option>
        <option value="Other">Other</option>
      </select>
    </label>

    <label>Date<input type="date" id="expDate" required /></label>

    <div style="margin-top:8px">
      <button class="primary" type="submit">Add Expense</button>
    </div>
  </form>

  <h4 style="margin-top:12px">Expenses List</h4>

  <table>
    <thead>
      <tr><th>Date</th><th>Name</th><th>Category</th><th>Amount</th><th>Action</th></tr>
    </thead>
    <tbody id="expenses"></tbody>
  </table>
</section>

</main>

<!-- JAVASCRIPT START -->
<script>
/* Storage keys */
const LS_ITEMS = 'pos_items_v_exp';
const LS_SALES = 'pos_sales_v_exp';
const LS_EXP = 'pos_expenses_v_exp';

/* Helpers */
const $ = id => document.getElementById(id);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const load = k => JSON.parse(localStorage.getItem(k) || '[]');
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
  /* Render Items */
function renderItems(filter='') {
  const items = load(LS_ITEMS);
  const tbody = $('items');
  tbody.innerHTML = '';

  const f = filter.trim().toLowerCase();

  items
    .filter(it => !f || it.name.toLowerCase().includes(f))
    .forEach(it => {
      const tr = document.createElement('tr');
      const profit = (parseFloat(it.sell) - parseFloat(it.buy)).toFixed(2);
      const lowClass = it.qty < 5 ? 'low' : '';

      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${parseFloat(it.buy).toFixed(2)}</td>
        <td>${parseFloat(it.sell).toFixed(2)}</td>
        <td>${profit}</td>
        <td class="${lowClass}">${it.qty}</td>
        <td>${it.loc || ''}</td>
        <td>
          <button class="edit" data-id="${it.id}">Edit</button>
          <button class="danger delItem" data-id="${it.id}">Delete</button>
        </td>
      `;

      tbody.appendChild(tr);
    });

  renderSaleSelect();
  calcInventoryValue();
}

/* Show Search Details Box */
function showSearchDetails(text) {
  const items = load(LS_ITEMS);
  const box = $('searchDetails');

  if (!text || !text.trim()) {
    box.style.display = 'none';
    return;
  }

  const exact = items.find(i => i.name.toLowerCase() === text.trim().toLowerCase());
  const partial = items.find(i => i.name.toLowerCase().includes(text.trim().toLowerCase()));

  const match = exact || partial;

  if (match) {
    box.style.display = 'block';
    box.innerHTML = `
      <b>Item Details</b><br>
      Name: ${match.name}<br>
      Buying Price: ₱${parseFloat(match.buy).toFixed(2)}<br>
      Selling Price: ₱${parseFloat(match.sell).toFixed(2)}<br>
      Profit per Unit: ₱${(parseFloat(match.sell)-parseFloat(match.buy)).toFixed(2)}<br>
      Remaining Stock: ${match.qty} ${match.qty < 5 ? '<span class="low">(LOW STOCK)</span>' : ''}<br>
      Location: ${match.loc || ''}
    `;
  } else {
    box.style.display = 'none';
  }
}

/* Render Sales */
function renderSales() {
  const sales = load(LS_SALES);
  const tbody = $('sales');
  tbody.innerHTML = '';

  sales.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.date}</td>
      <td>${s.item}</td>
      <td>${s.qty}</td>
      <td>₱${parseFloat(s.total).toFixed(2)}</td>
      <td>₱${parseFloat(s.profit).toFixed(2)}</td>
      <td><button class="danger delSale" data-id="${s.id}">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });

  calcReports();
}

/* Sale Item Dropdown */
function renderSaleSelect() {
  const sel = $('saleItem');
  sel.innerHTML = '';

  load(LS_ITEMS).forEach(i => {
    const op = document.createElement('option');
    op.value = i.id;
    op.textContent = `${i.name} (stock ${i.qty})`;
    sel.appendChild(op);
  });
}

/* Render Expenses */
function renderExpenses() {
  const ex = load(LS_EXP);
  const tbody = $('expenses');
  tbody.innerHTML = '';

  ex.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.name}</td>
      <td>${e.category}</td>
      <td>₱${parseFloat(e.amount).toFixed(2)}</td>
      <td><button class="danger delExp" data-id="${e.id}">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });

  calcReports();
  }
  /* Compute Total Inventory Value */
function calcInventoryValue() {
  const items = load(LS_ITEMS);
  let total = 0;

  items.forEach(i => {
    total += (parseFloat(i.buy) || 0) * (parseInt(i.qty) || 0);
  });

  $('invValue').textContent = total.toFixed(2);
}

/* Compute Reports (Sales Profit, Expenses, Net Profit) */
function calcReports() {
  const sales = load(LS_SALES);
  const expenses = load(LS_EXP);

  const today = new Date().toISOString().slice(0, 10);
  const month = new Date().toISOString().slice(0, 7);

  let salesToday = 0, salesMonth = 0;
  let expToday = 0, expMonth = 0;

  /* sum sales profit */
  sales.forEach(s => {
    if (s.date === today) salesToday += parseFloat(s.profit) || 0;
    if (s.date && s.date.slice(0,7) === month) salesMonth += parseFloat(s.profit) || 0;
  });

  /* sum expenses */
  expenses.forEach(e => {
    if (e.date === today) expToday += parseFloat(e.amount) || 0;
    if (e.date && e.date.slice(0,7) === month) expMonth += parseFloat(e.amount) || 0;
  });

  /* compute net */
  $('salesProfitToday').textContent = salesToday.toFixed(2);
  $('expensesToday').textContent = expToday.toFixed(2);
  $('netToday').textContent = (salesToday - expToday).toFixed(2);

  $('salesProfitMonth').textContent = salesMonth.toFixed(2);
  $('expensesMonth').textContent = expMonth.toFixed(2);
  $('netMonth').textContent = (salesMonth - expMonth).toFixed(2);
}

/* CLICK EVENTS: edit, delete sale, delete item, delete expense */
document.addEventListener('click', function(e) {

  /* EDIT ITEM */
  if (e.target.classList.contains('edit')) {
    const id = e.target.dataset.id;
    const it = load(LS_ITEMS).find(x => x.id === id);

    if (!it) return;

    $('itemId').value = it.id;
    $('name').value = it.name;
    $('buy').value = it.buy;
    $('sell').value = it.sell;
    $('qty').value = it.qty;
    $('loc').value = it.loc;
  }

  /* DELETE ITEM (with auto restore stock from all sales) */
  if (e.target.classList.contains('delItem')) {
    if (!confirm('Delete item? All related sales will also be removed. Stock will be restored before deletion.')) return;

    const id = e.target.dataset.id;

    let items = load(LS_ITEMS);
    let sales = load(LS_SALES);

    const it = items.find(i => i.id === id);

    if (it) {
      // restore stock from all sales for this item
      sales.forEach(s => {
        if (s.item === it.name) {
          it.qty += parseInt(s.qty);
        }
      });

      // save updated item list
      save(LS_ITEMS, items);

      // remove all sales for this item
      sales = sales.filter(s => s.item !== it.name);
      save(LS_SALES, sales);

      // remove item
      items = items.filter(i => i.id !== id);
      save(LS_ITEMS, items);

      renderItems();
      renderSales();
      calcInventoryValue();
      calcReports();
    }
  }

  /* DELETE SALE (auto return stock) */
  if (e.target.classList.contains('delSale')) {
    if (!confirm('Delete this sale? Stock will be returned.')) return;

    const id = e.target.dataset.id;

    let sales = load(LS_SALES);
    const sale = sales.find(s => s.id === id);

    if (sale) {
      let items = load(LS_ITEMS);
      let it = items.find(i => i.name === sale.item);

      if (it) {
        it.qty += parseInt(sale.qty);
        save(LS_ITEMS, items);
      }

      sales = sales.filter(s => s.id !== id);
      save(LS_SALES, sales);

      renderItems();
      renderSales();
      calcInventoryValue();
      calcReports();
    }
  }

  /* DELETE EXPENSE */
  if (e.target.classList.contains('delExp')) {
    if (!confirm('Delete this expense?')) return;

    let ex = load(LS_EXP);
    const id = e.target.dataset.id;

    ex = ex.filter(x => x.id !== id);

    save(LS_EXP, ex);
    renderExpenses();
    calcReports();
  }
});
  /* ADD / EDIT ITEM */
$('itemForm').addEventListener('submit', function(ev) {
  ev.preventDefault();

  const id = $('itemId').value || uid();

  const obj = {
    id: id,
    name: $('name').value.trim(),
    buy: parseFloat($('buy').value) || 0,
    sell: parseFloat($('sell').value) || 0,
    qty: parseInt($('qty').value) || 0,
    loc: $('loc').value.trim()
  };

  const items = load(LS_ITEMS);
  const exists = items.find(x => x.id === id);

  if (exists) {
    Object.assign(exists, obj);
  } else {
    items.push(obj);
  }

  save(LS_ITEMS, items);

  $('itemForm').reset();
  $('itemId').value = '';

  renderItems();
});

/* ADD SALE */
$('saleForm').addEventListener('submit', function(ev) {
  ev.preventDefault();

  const itemId = $('saleItem').value;
  const qty = parseInt($('saleQty').value) || 0;
  const date = $('saleDate').value;

  if (!itemId) {
    alert('No item selected.');
    return;
  }

  const items = load(LS_ITEMS);
  const it = items.find(i => i.id === itemId);

  if (!it) {
    alert('Item not found.');
    return;
  }

  if (qty > it.qty) {
    if (!confirm('Quantity exceeds stock. Continue?')) return;
  }

  const total = qty * parseFloat(it.sell);
  const profit = qty * (parseFloat(it.sell) - parseFloat(it.buy));

  it.qty -= qty;
  save(LS_ITEMS, items);

  const sales = load(LS_SALES);
  sales.push({
    id: uid(),
    item: it.name,
    qty: qty,
    date: date,
    total: total,
    profit: profit
  });

  save(LS_SALES, sales);

  renderItems();
  renderSales();
});


/* ADD EXPENSE */
$('expenseForm').addEventListener('submit', function(ev) {
  ev.preventDefault();

  const name = $('expName').value.trim();
  const amount = parseFloat($('expAmount').value) || 0;
  const category = $('expCategory').value;
  const date = $('expDate').value;

  const ex = load(LS_EXP);
  ex.push({
    id: uid(),
    name: name,
    amount: amount,
    category: category,
    date: date
  });

  save(LS_EXP, ex);

  $('expenseForm').reset();

  renderExpenses();
});



/* SEARCH BAR */
$('search').addEventListener('input', function(e) {
  const text = e.target.value;
  renderItems(text);
  showSearchDetails(text);
});


/* EXPORT BACKUP (Items + Sales + Expenses) */
$('exportBtn').addEventListener('click', function() {
  const data = {
    items: load(LS_ITEMS),
    sales: load(LS_SALES),
    expenses: load(LS_EXP),
    exportedAt: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pos_backup_' + Date.now() + '.json';
  a.click();
});


/* IMPORT BACKUP */
$('importBtn').addEventListener('click', function() {
  $('importFile').click();
});

$('importFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function() {
    try {
      const data = JSON.parse(reader.result);

      save(LS_ITEMS, data.items || []);
      save(LS_SALES, data.sales || []);
      save(LS_EXP, data.expenses || []);

      alert("Backup successfully imported!");

      renderItems();
      renderSales();
      renderExpenses();
      calcReports();

    } catch (err) {
      alert("Invalid backup file.");
    }
  };

  reader.readAsText(file);
});


/* CLEAR ALL (DEVELOPER BUTTON) */
$('clearAll').addEventListener('click', function() {
  if (!confirm('Delete ALL data? Items, sales, expenses?')) return;

  localStorage.removeItem(LS_ITEMS);
  localStorage.removeItem(LS_SALES);
  localStorage.removeItem(LS_EXP);

  renderItems();
  renderSales();
  renderExpenses();
  calcReports();
});


/* INITIAL LOAD */
document.addEventListener('DOMContentLoaded', function() {
  $('saleDate').value = new Date().toISOString().slice(0,10);
  $('expDate').value = new Date().toISOString().slice(0,10);

  renderItems();
  renderSales();
  renderExpenses();
  calcReports();
});
</script>

</body>
</html>
