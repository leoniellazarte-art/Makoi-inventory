<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POS - Motor Shop (Makoi)</title>

  <style>
    /* ========== Global / Layout ========== */
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --muted:#666;
      --primary:#0b79d0;
      --danger:#d03b3b;
      --ok:#28a745;
      --border:#e6e9ef;
      --radius:8px;
      --gap:12px;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#222}
    header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}

    .container{max-width:1200px;margin:16px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 1px 3px rgba(15,20,30,0.03)}
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin-bottom:8px;font-size:14px}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:8px;margin-top:4px;border:1px solid var(--border);border-radius:6px;font-size:14px
    }
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:var(--primary);color:#fff}
    button.secondary{background:#6c757d}
    button.danger{background:var(--danger)}
    button.ok{background:var(--ok)}

    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    thead th{background:#f1f5fa;padding:8px;border-bottom:1px solid var(--border);text-align:left}
    tbody td{padding:8px;border-bottom:1px solid #f2f4f7}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{width:110px}
    .muted{color:var(--muted);font-size:13px}

    /* HIDE items list by default */
    #itemTableContainer{display:none}

    /* suggestions */
    .suggestBox{position:relative}
    .suggestList{position:absolute;left:0;right:0;z-index:40;background:#fff;border:1px solid var(--border);border-radius:6px;max-height:260px;overflow:auto;box-shadow:0 6px 18px rgba(10,20,40,0.06);display:none}
    .suggestItem{padding:10px;border-bottom:1px solid #f2f4f7;cursor:pointer}
    .suggestItem:last-child{border-bottom:0}
    .s-title{font-weight:700}
    .s-meta{font-size:13px;color:#666;margin-top:6px}
    .low{color:var(--danger);font-weight:700}
    .info{margin-top:10px;padding:10px;border-radius:6px;background:#fbfdff;border:1px solid #eef4fb}

    footer{margin:20px 0;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>

<body>
  <header>
    <h1>POS - Motor Shop (Makoi)</h1>
    <div class="controls">
      <button id="exportBackup">Export Backup</button>
      <input id="importFile" type="file" style="display:none" />
      <button id="importBackup" class="secondary">Import Backup</button>
      <button id="clearAll" class="danger">Clear ALL</button>
    </div>
  </header>

  <div class="container">
    <!-- grid: left = items / right = sales + reports -->
    <div class="grid">
      <!-- LEFT: ITEMS -->
      <section class="card" id="itemsCard">
        <h2>Items</h2>

        <form id="itemForm">
          <input type="hidden" id="itemId" value="">
          <div class="row">
            <div style="flex:1;min-width:180px">
              <label>Item Name
                <input id="name" type="text" placeholder="e.g. Spark Plug" required>
              </label>
            </div>

            <div class="small">
              <label>Buy (₱)
                <input id="buy" type="number" step="0.01" placeholder="0.00" required>
              </label>
            </div>

            <div class="small">
              <label>Sell (₱)
                <input id="sell" type="number" step="0.01" placeholder="0.00" required>
              </label>
            </div>

            <div class="small">
              <label>Qty
                <input id="qty" type="number" step="1" value="0" required>
              </label>
            </div>

            <div style="flex:1;min-width:140px">
              <label>Location
                <input id="loc" type="text" placeholder="e.g. Shelf A">
              </label>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <button type="submit">Save Item</button>
            <button type="button" id="cancelItem" class="secondary">Cancel</button>
          </div>
        </form>

        <hr style="margin:12px 0">

        <label>Search Items (type first letter — list hidden until you type)</label>
        <input id="search" type="text" placeholder="Type to search items (list hidden until you type)">

        <div id="searchDetails" style="display:none;margin-top:8px" class="info"></div>

        <!-- Hidden table: shows only when you type in search box -->
        <div id="itemTableContainer" style="margin-top:10px">
          <table aria-label="Items table">
            <thead>
              <tr><th>Name</th><th>Buy</th><th>Sell</th><th>Profit</th><th>Qty</th><th>Location</th><th>Actions</th></tr>
            </thead>
            <tbody id="items"></tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT COLUMN STARTS: SALES + EXPENSES -->
      <div>
        <!-- SALE SECTION -->
        <section class="card" id="saleCard">
          <h2>Record Sale (search-style)</h2>

          <div class="row suggestBox" style="position:relative;max-width:720px">
            <div style="flex:1">
              <label>Search Item to Sell
                <input id="saleSearch" type="text" placeholder="Type item name (first letter will show suggestions)" autocomplete="off">
              </label>
            </div>
            <div style="width:110px">
              <label>Qty
                <input id="saleQty" type="number" min="1" value="1">
              </label>
            </div>
            <div style="width:160px">
              <label>Date
                <input id="saleDate" type="date">
              </label>
            </div>
          </div>

          <div id="saleSuggestList" class="suggestList" role="listbox" aria-label="Sale suggestions"></div>

          <input type="hidden" id="saleItemId" value="">

          <div style="margin-top:8px">
            <button id="addSale">Add Sale</button>
          </div>

          <hr style="margin:12px 0">

          <h3>Sales</h3>
          <table aria-label="Sales table">
            <thead><tr><th>Date</th><th>Item</th><th>Qty</th><th>Total</th><th>Profit</th><th>Actions</th></tr></thead>
            <tbody id="sales"></tbody>
          </table>
        </section>

        <!-- EXPENSE SECTION -->
        <section class="card" id="expenseCard" style="margin-top:16px">
          <h2>Expenses</h2>

          <form id="expenseForm">
            <div class="row">
              <div style="flex:1">
                <label>Expense Name
                  <input id="expName" type="text" placeholder="e.g. Fuel, Snacks" required>
                </label>
              </div>

              <div class="small">
                <label>Amount (₱)
                  <input id="expAmount" type="number" step="0.01" required>
                </label>
              </div>

              <div style="width:160px">
                <label>Category
                  <input id="expCategory" type="text" placeholder="e.g. Fuel">
                </label>
              </div>

              <div style="width:160px">
                <label>Date
                  <input id="expDate" type="date">
                </label>
              </div>
            </div>

            <div style="margin-top:8px">
              <button type="submit">Add Expense</button>
            </div>
          </form>

          <hr style="margin:12px 0">

          <div id="expenses" aria-live="polite"> <!-- JS will render expense rows here --> </div>
        </section>
      </div> <!-- end right column -->
      <script>
/* ===============================================
   CONSTANTS / HELPERS
================================================ */
const LS_ITEMS = "mk_items";
const LS_SALES = "mk_sales";
const LS_EXP   = "mk_exp";

const $ = id => document.getElementById(id);
const load = key => JSON.parse(localStorage.getItem(key) || "[]");
const save = (key, value) => localStorage.setItem(key, JSON.stringify(value));
const uid  = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const fmt  = n => Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

/* ===============================================
   ITEMS: ADD / EDIT / DUPLICATE CHECK
================================================ */
$("itemForm").addEventListener("submit", e => {
  e.preventDefault();

  const id = $("itemId").value || uid();
  const item = {
    id,
    name: $("name").value.trim(),
    buy:  parseFloat($("buy").value)||0,
    sell: parseFloat($("sell").value)||0,
    qty:  parseInt($("qty").value)||0,
    loc:  $("loc").value.trim()
  };

  const items = load(LS_ITEMS);

  // duplicate name check, ignore same id on edit
  const dup = items.find(i => i.name.toLowerCase() === item.name.toLowerCase() && i.id !== id);
  if (dup) {
    alert("❗ Item name already exists. Choose another name.");
    return;
  }

  // save or update
  const exist = items.find(i => i.id === id);
  if (exist) Object.assign(exist, item);
  else items.push(item);

  save(LS_ITEMS, items);
  $("itemForm").reset();
  $("itemId").value = "";

  renderItems();
  calcInventory();
});

/* Cancel edit */
$("cancelItem").addEventListener("click", () => {
  $("itemForm").reset();
  $("itemId").value = "";
});

/* ===============================================
   RENDER ITEMS TABLE
================================================ */
function renderItems() {
  const items = load(LS_ITEMS);
  const body = $("items");
  body.innerHTML = "";

  items.forEach(i => {
    const tr = document.createElement("tr");
    const profit = i.sell - i.buy;
    const low = (i.qty < 5 ? "low" : "");

    tr.innerHTML = `
      <td>${i.name}</td>
      <td>₱${fmt(i.buy)}</td>
      <td>₱${fmt(i.sell)}</td>
      <td>₱${fmt(profit)}</td>
      <td class="${low}">${i.qty}</td>
      <td>${i.loc}</td>
      <td>
        <button class="editItem" data-id="${i.id}">Edit</button>
        <button class="delItem danger" data-id="${i.id}">Delete</button>
      </td>
    `;
    body.appendChild(tr);
  });
}

/* Edit / Delete Item */
document.addEventListener("click", e => {

  /* EDIT ITEM */
  if (e.target.classList.contains("editItem")) {
    const id = e.target.dataset.id;
    const items = load(LS_ITEMS);
    const it = items.find(x => x.id === id);
    if (!it) return;

    $("itemId").value = it.id;
    $("name").value  = it.name;
    $("buy").value   = it.buy;
    $("sell").value  = it.sell;
    $("qty").value   = it.qty;
    $("loc").value   = it.loc;

    window.scrollTo({top:0, behavior:"smooth"});
  }

  /* DELETE ITEM */
  if (e.target.classList.contains("delItem")) {
    if (!confirm("Delete this item?")) return;

    const id = e.target.dataset.id;
    let items = load(LS_ITEMS);
    let sales = load(LS_SALES);

    // delete item
    items = items.filter(i => i.id !== id);

    // delete ALL SALES THAT USED THIS ITEM
    sales = sales.filter(s => s.itemId !== id);

    save(LS_ITEMS, items);
    save(LS_SALES, sales);

    renderItems();
    renderSales();
    calcInventory();
  }
});
        /* ===============================================
   SALES SUGGESTIONS (first letter match)
================================================ */
$("saleSearch").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();
  const list = $("saleSuggestList");
  const items = load(LS_ITEMS);

  if (!q) {
    list.style.display = "none";
    return;
  }

  // startsWith matching
  const match = items.filter(i => i.name.toLowerCase().startsWith(q));

  if (match.length === 0) {
    list.style.display = "none";
    return;
  }

  list.innerHTML = "";
  match.forEach(it => {
    const div = document.createElement("div");
    div.className = "suggestItem";
    div.dataset.id = it.id;

    div.innerHTML = `
      <div class="s-title">${it.name}</div>
      <div class="s-meta">
        Buy: ₱${fmt(it.buy)} |
        Sell: ₱${fmt(it.sell)} |
        Profit: ₱${fmt(it.sell - it.buy)} |
        Stock: ${it.qty}
      </div>
    `;
    list.appendChild(div);
  });

  list.style.display = "block";
});

/* click suggestion */
$("saleSuggestList").addEventListener("click", e => {
  if (e.target.closest(".suggestItem")) {
    const itemDiv = e.target.closest(".suggestItem");
    const id = itemDiv.dataset.id;

    const items = load(LS_ITEMS);
    const it = items.find(x => x.id === id);
    if (!it) return;

    $("saleItemId").value = it.id;
    $("saleSearch").value = it.name;
    $("saleQty").value = 1;
    $("saleSuggestList").style.display = "none";
  }
});

/* close suggestion when clicking outside */
document.addEventListener("click", e => {
  if (!e.target.closest("#saleSuggestList") && e.target.id !== "saleSearch") {
    $("saleSuggestList").style.display = "none";
  }
});

/* ===============================================
   ADD SALE
================================================ */
$("addSale").addEventListener("click", e => {
  e.preventDefault();

  const itemId = $("saleItemId").value;
  const qty = parseInt($("saleQty").value) || 1;
  const date = $("saleDate").value || new Date().toISOString().slice(0, 10);

  if (!itemId) {
    alert("Choose an item from suggestion list.");
    return;
  }

  const items = load(LS_ITEMS);
  const it = items.find(x => x.id === itemId);
  if (!it) return;

  if (it.qty < qty) {
    if (!confirm("Stock is not enough. Allow negative stock?")) return;
  }

  const sales = load(LS_SALES);
  const profit = (it.sell - it.buy) * qty;

  sales.push({
    id: uid(),
    itemId: it.id,
    item: it.name,
    qty,
    total: it.sell * qty,
    profit,
    date
  });

  // deduct stock
  it.qty = (parseInt(it.qty) || 0) - qty;

  save(LS_ITEMS, items);
  save(LS_SALES, sales);

  $("saleItemId").value = "";
  $("saleSearch").value = "";
  $("saleQty").value = 1;

  renderItems();
  renderSales();
  calcInventory();
  calcReports();
});

/* ===============================================
   RENDER SALES TABLE
================================================ */
function renderSales() {
  const sales = load(LS_SALES);
  const body = $("sales");
  body.innerHTML = "";

  sales.forEach(s => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${s.date}</td>
      <td>${s.item}</td>
      <td>${s.qty}</td>
      <td>₱${fmt(s.total)}</td>
      <td>₱${fmt(s.profit)}</td>
      <td><button class="deleteSale danger" data-id="${s.id}">Delete</button></td>
    `;

    body.appendChild(tr);
  });
}

/* ===============================================
   DELETE SALE (PER ITEM ONLY + DOUBLE CONFIRM)
================================================ */
document.addEventListener("click", e => {
  if (e.target.classList.contains("deleteSale")) {

    if (!confirm("Are you sure you want to delete this sale?")) return;
    if (!confirm("FINAL confirmation: This will restore the stock of this sale only. Continue?")) return;

    const id = e.target.dataset.id;
    let sales = load(LS_SALES);
    const sale = sales.find(x => x.id === id);
    if (!sale) return;

    // restore stock
    let items = load(LS_ITEMS);
    const it = items.find(i => i.id === sale.itemId);
    if (it) {
      it.qty = (parseInt(it.qty) || 0) + (parseInt(sale.qty) || 0);
      save(LS_ITEMS, items);
    }

    // delete specific sale only
    sales = sales.filter(s => s.id !== id);
    save(LS_SALES, sales);

    renderItems();
    renderSales();
    calcInventory();
    calcReports();
  }
});
        /* ===============================================
   EXPENSES: ADD / RENDER / DELETE
================================================ */
$("expenseForm").addEventListener("submit", e => {
  e.preventDefault();

  const name = $("expName").value.trim();
  const amount = parseFloat($("expAmount").value) || 0;
  const cat = $("expCategory").value.trim();
  const date = $("expDate").value || new Date().toISOString().slice(0,10);

  const ex = load(LS_EXP);
  ex.push({
    id: uid(),
    name,
    amount,
    category: cat,
    date
  });

  save(LS_EXP, ex);
  $("expenseForm").reset();

  renderExpenses();
  calcReports();
});

function renderExpenses(){
  const ex = load(LS_EXP);
  const box = $("expenses");
  box.innerHTML = "";

  if (!ex.length) {
    box.innerHTML = `<div class="muted">No expenses recorded.</div>`;
    return;
  }

  ex.forEach(e => {
    const row = document.createElement("div");
    row.className = "row";

    row.innerHTML = `
      <div style="flex:1">${e.date} — ${e.name} — ₱${fmt(e.amount)}</div>
      <button class="delExp danger" data-id="${e.id}">Delete</button>
    `;
    box.appendChild(row);
  });
}

/* DELETE EXPENSE */
document.addEventListener("click", e => {
  if (e.target.classList.contains("delExp")) {

    if (!confirm("Delete this expense?")) return;

    const id = e.target.dataset.id;
    let ex = load(LS_EXP);

    ex = ex.filter(x => x.id !== id);
    save(LS_EXP, ex);

    renderExpenses();
    calcReports();
  }
});


/* ===============================================
   INVENTORY VALUE
================================================ */
function calcInventory(){
  const items = load(LS_ITEMS);
  let total = 0;

  items.forEach(i => {
    total += (parseFloat(i.buy) || 0) * (parseInt(i.qty) || 0);
  });

  $("invValue").textContent = "₱" + fmt(total);
}


/* ===============================================
   REPORTS: TOTAL SALES, PROFIT, EXPENSES, NET
================================================ */
function calcReports(){
  const sales = load(LS_SALES);
  const exp   = load(LS_EXP);

  let totalSales = 0, totalProfit = 0, totalExp = 0;

  sales.forEach(s => {
    totalSales += parseFloat(s.total) || 0;
    totalProfit += parseFloat(s.profit) || 0;
  });

  exp.forEach(e => totalExp += parseFloat(e.amount) || 0);

  const net = totalProfit - totalExp;

  const sum = $("histSummary");
  if (sum) {
    sum.innerHTML = `
      <div><strong>Total Sales:</strong> ₱${fmt(totalSales)}</div>
      <div><strong>Total Profit (before expenses):</strong> ₱${fmt(totalProfit)}</div>
      <div><strong>Total Expenses:</strong> ₱${fmt(totalExp)}</div>
      <div><strong>Net Profit:</strong> ₱${fmt(net)}</div>
    `;
  }
}


/* ===============================================
   SALES HISTORY FILTER
================================================ */
function monthOptions(){
  const sel = $("histMonth");
  const now = new Date();

  for (let m = 0; m < 12; m++) {
    const d = new Date(now.getFullYear(), m, 1);

    const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const txt = d.toLocaleString("default", {month:"long", year:"numeric"});

    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = txt;
    sel.appendChild(opt);
  }
}
monthOptions();


$("histFilter").addEventListener("click", () => {

  let filtered = load(LS_SALES);

  const sd = $("histDate").value;
  const rf = $("histFrom").value;
  const rt = $("histTo").value;
  const month = $("histMonth").value;

  if (sd) {
    filtered = filtered.filter(s => s.date === sd);
  }
  else if (rf || rt) {
    if (rf) filtered = filtered.filter(s => s.date >= rf);
    if (rt) filtered = filtered.filter(s => s.date <= rt);
  }
  else if (month) {
    filtered = filtered.filter(s => s.date.startsWith(month));
  }

  renderHistory(filtered);
});

$("histClear").addEventListener("click", () => {
  $("histDate").value = "";
  $("histFrom").value = "";
  $("histTo").value = "";
  $("histMonth").value = "";

  $("histResults").innerHTML = "";
  $("histSummary").innerHTML = "";
});


/* ===============================================
   RENDER FILTERED HISTORY
================================================ */
function renderHistory(rows){
  const body = $("histResults");
  body.innerHTML = "";

  let totalSales = 0;
  let totalProfit = 0;

  rows.forEach(s => {
    totalSales += s.total;
    totalProfit += s.profit;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.date}</td>
      <td>${s.item}</td>
      <td>${s.qty}</td>
      <td>₱${fmt(s.total)}</td>
      <td>₱${fmt(s.profit)}</td>
      <td><button class="deleteSale danger" data-id="${s.id}">Delete</button></td>
    `;
    body.appendChild(tr);
  });

  $("histSummary").innerHTML = `
    <div><strong>Total Sales:</strong> ₱${fmt(totalSales)}</div>
    <div><strong>Total Profit (before expenses):</strong> ₱${fmt(totalProfit)}</div>
    <div><strong>Records:</strong> ${rows.length}</div>
  `;
                  }
        /* ===============================================
   BACKUP SYSTEM (EXPORT / IMPORT)
================================================ */
$("exportBackup").addEventListener("click", () => {
  const data = {
    items: load(LS_ITEMS),
    sales: load(LS_SALES),
    expenses: load(LS_EXP)
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url  = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "makoi-pos-backup.json";
  a.click();

  URL.revokeObjectURL(url);
});


$("importBackup").addEventListener("click", () => {
  const file = $("importFile").files[0];

  if (!file) {
    alert("Please choose a backup file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      if (data.items) save(LS_ITEMS, data.items);
      if (data.sales) save(LS_SALES, data.sales);
      if (data.expenses) save(LS_EXP, data.expenses);

      renderAll();
      alert("Backup successfully restored!");

    } catch (err) {
      alert("Invalid backup file.");
    }
  };

  reader.readAsText(file);
});


/* ===============================================
   CLEAR ALL DATA
================================================ */
$("clearAll").addEventListener("click", () => {
  if (!confirm("Are you sure you want to CLEAR ALL DATA?")) return;
  if (!confirm("FINAL confirmation: This will remove ALL items, sales, and expenses. Continue?")) return;

  localStorage.removeItem(LS_ITEMS);
  localStorage.removeItem(LS_SALES);
  localStorage.removeItem(LS_EXP);

  renderAll();
  alert("All data cleared.");
});


/* ===============================================
   RENDER ALL SECTIONS
================================================ */
function renderAll(){
  renderItems();
  renderSales();
  renderExpenses();
  calcInventory();
  calcReports();
}


/* ===============================================
   INITIAL LOAD
================================================ */
document.addEventListener("DOMContentLoaded", () => {

  // auto-set default date fields
  const today = new Date().toISOString().slice(0,10);

  if ($("saleDate")) $("saleDate").value = today;
  if ($("expDate")) $("expDate").value = today;
  if ($("histDate")) $("histDate").value = today;

  renderAll();
});
</script>
</body>
</html>
