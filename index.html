<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>POS - Motor Shop Full System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #f8f9fa;
}

header {
  background: #fff;
  padding: 15px;
  border-bottom: 2px solid #ddd;
  text-align: center;
}

h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.container {
  padding: 15px;
  max-width: 1100px;
  margin: auto;
}

section {
  background: #fff;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.08);
}

section h2 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 20px;
}

/* BUTTONS */
button {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
  margin: 3px 0;
}
button:hover {
  background: #0056b3;
}

input[type="text"], 
input[type="number"], 
input[type="date"] {
  width: 100%;
  padding: 7px;
  margin: 2px 0 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table th, table td {
  padding: 8px;
  border: 1px solid #ccc;
  text-align: center;
}
table th {
  background: #f1f1f1;
}

/* HIDDEN ITEM LIST */
#itemTableContainer {
  display: none;
}

/* SUGGEST BOX */
.suggestBox {
  position: relative;
}

.suggestList {
  position: absolute;
  top: 35px;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  max-height: 250px;
  overflow-y: auto;
  z-index: 50;
  display: none;
}

.suggestItem {
  padding: 8px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}
.suggestItem:last-child {
  border-bottom: none;
}

.suggestItem:hover {
  background: #dbe8ff;
}

.s-title {
  font-weight: bold;
  font-size: 15px;
}

.s-meta {
  font-size: 12px;
  color: #444;
}
</style>
</head>

<body>
<header><h1>POS – Motor Shop</h1></header>

<div class="container">
  <!-- PART 2: ITEMS (hidden by default) + SALE SEARCH UI -->
  <section>
    <h2>Add / Edit Item</h2>

    <form id="itemForm">
      <input type="hidden" id="itemId" value="" />

      <label>Item Name
        <input id="name" type="text" placeholder="e.g. Spark Plug" required />
      </label>

      <label>Buying Price (₱)
        <input id="buy" type="number" step="0.01" placeholder="0.00" required />
      </label>

      <label>Selling Price (₱)
        <input id="sell" type="number" step="0.01" placeholder="0.00" required />
      </label>

      <label>Quantity
        <input id="qty" type="number" step="1" value="1" required />
      </label>

      <label>Location
        <input id="loc" type="text" placeholder="e.g. Shelf A" />
      </label>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button type="submit">Save Item</button>
        <button type="button" id="cancelItem" style="background:#6c757d">Cancel</button>
      </div>
    </form>

    <hr style="margin:12px 0">

    <h2>Search Items (list hidden by default)</h2>
    <input id="search" type="text" placeholder="Type to search items (list hidden until you type)">

    <div id="searchDetails" style="display:none;margin-top:8px;padding:8px;border:1px solid #eee;border-radius:4px;background:#fafafa;">
      <!-- populated by JS: item details (buy, sell, profit, stock, location) -->
    </div>

    <!-- Hidden item list container — will only show when user types in search -->
    <div id="itemTableContainer" style="margin-top:10px;">
      <table aria-label="Items table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Buy</th>
            <th>Sell</th>
            <th>Profit</th>
            <th>Qty</th>
            <th>Location</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="items"></tbody>
      </table>
    </div>

  </section><!-- EXPENSE SECTION -->
<section>
  <h2>Expenses</h2>

  <form id="expenseForm">
    <label>Expense Name
      <input type="text" id="expName" placeholder="e.g. Gasoline, Load, Snacks" required>
    </label>

    <label>Amount (₱)
      <input type="number" id="expAmount" step="0.01" required>
    </label>

    <label>Category
      <input type="text" id="expCategory" placeholder="e.g. Transportation, Utilities" required>
    </label>

    <label>Date
      <input type="date" id="expDate" required>
    </label>

    <button type="submit">Add Expense</button>
  </form>

  <hr style="margin:12px 0">

  <table aria-label="Expenses table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Category</th>
        <th>Amount</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="expenses"></tbody>
  </table>
</section>

  <!-- SALE SECTION (search-style selector) -->
  <section>
    <h2>Record Sale (search-style)</h2>

    <div class="suggestBox" style="margin-bottom:8px;">
      <label>Search Item to Sell
        <input id="saleSearch" type="text" placeholder="Type item name (first letter will show suggestions)" autocomplete="off" />
      </label>

      <!-- suggestions list (Style B: details are shown) -->
      <div id="saleSuggestList" class="suggestList" role="listbox" aria-label="Sale suggestions">
        <!-- populated by JS:
             each .suggestItem contains:
             <div class="s-title">Item Name</div>
             <div class="s-meta">₱Buy • ₱Sell • Profit:₱X • Stock: N • Loc</div>
        -->
      </div>
    </div>

    <!-- Hidden fields that JS will fill when user clicks a suggestion -->
    <input type="hidden" id="saleItemId" value="" />
    <label>Quantity
      <input id="saleQty" type="number" min="1" value="1" />
    </label>
    <label>Date
      <input id="saleDate" type="date" />
    </label>

    <div style="margin-top:8px;">
      <button id="addSale" type="button">Add Sale</button>
    </div>

    <hr style="margin:12px 0">

    <h3>Sales</h3>
    <table aria-label="Sales table">
      <thead>
        <tr><th>Date</th><th>Item</th><th>Qty</th><th>Total</th><th>Profit</th><th>Actions</th></tr>
      </thead>
      <tbody id="sales"></tbody>
    </table>
  </section>

  <!-- small info panel -->
  <section>
    <h2>Inventory Info</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="padding:8px;border:1px solid #eee;border-radius:4px;background:#fff;">
        <div style="font-size:13px;color:#666">Total Inventory Value</div>
        <div style="font-weight:700;font-size:18px">₱<span id="invValue">0.00</span></div>
      </div>

      <div style="padding:8px;border:1px solid #eee;border-radius:4px;background:#fff;">
        <div style="font-size:13px;color:#666">Low Stock Threshold</div>
        <div style="font-weight:700">Qty &lt; <span id="lowThreshold">5</span></div>
      </div>
    </div>
  </section>
</div> <!-- end container -->
  <script>
/* -----------------------
   STORAGE KEYS + HELPERS
------------------------*/
const LS_ITEMS = 'pos_items_v_final';
const LS_SALES = 'pos_sales_v_final';
const LS_EXP   = 'pos_exp_v_final';

const $ = id => document.getElementById(id);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const load = k => { try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch(e) { return []; } };
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

/* -----------------------
   RENDER ITEMS (hidden unless search)
------------------------*/
function renderItems(filter='') {
  const items = load(LS_ITEMS);
  const tbody = $('items');
  tbody.innerHTML = '';

  const q = (filter||'').trim().toLowerCase();

  // show or hide the item table container
  $('itemTableContainer').style.display = q.length ? 'block' : 'none';

  items
    .filter(it => !q || it.name.toLowerCase().includes(q))
    .forEach(it => {
      const profitPer = (parseFloat(it.sell) - parseFloat(it.buy)) || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left">${it.name}</td>
        <td>₱${parseFloat(it.buy).toFixed(2)}</td>
        <td>₱${parseFloat(it.sell).toFixed(2)}</td>
        <td>₱${profitPer.toFixed(2)}</td>
        <td ${ (parseInt(it.qty)||0) < (parseInt($('lowThreshold').textContent)||5) ? 'style="color:#d03b3b;font-weight:700"' : ''}>${it.qty}</td>
        <td>${it.loc || ''}</td>
        <td>
          <button class="editItem" data-id="${it.id}" style="background:#28a745">Edit</button>
          <button class="delItem" data-id="${it.id}" style="background:#dc3545">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

  // update inventory value
  calcInventory();
}

/* -----------------------
   SHOW SEARCH DETAILS BOX
------------------------*/
function showSearchDetails(text) {
  const box = $('searchDetails');
  if (!text || !text.trim()) { box.style.display = 'none'; box.innerHTML = ''; return; }

  const items = load(LS_ITEMS);
  const match = items.find(i => i.name.toLowerCase() === text.trim().toLowerCase()) ||
                items.find(i => i.name.toLowerCase().includes(text.trim().toLowerCase()));

  if (!match) { box.style.display = 'none'; box.innerHTML = ''; return; }

  const profitPer = (parseFloat(match.sell) - parseFloat(match.buy)) || 0;

  box.style.display = 'block';
  box.innerHTML = `
    <b>Item Details</b><br>
    Name: ${match.name}<br>
    Buying: ₱${parseFloat(match.buy).toFixed(2)}<br>
    Selling: ₱${parseFloat(match.sell).toFixed(2)}<br>
    Profit/unit: ₱${profitPer.toFixed(2)}<br>
    Remaining stock: ${match.qty} ${ (parseInt(match.qty)||0) < (parseInt($('lowThreshold').textContent)||5) ? '<span style="color:#d03b3b;font-weight:700">(LOW)</span>' : '' }<br>
    Location: ${match.loc || ''}
  `;
}

/* -----------------------
   SALE SUGGESTIONS (Style B: details)
   Match on first letter too (so one char typed shows matches)
------------------------*/
function showSaleSuggestions(text) {
  const box = $('saleSuggestList');
  box.innerHTML = '';

  const q = (text||'').trim().toLowerCase();
  if (!q) { box.style.display = 'none'; return; }

  const items = load(LS_ITEMS);
  // prioritize items whose name startsWith query, then includes
  const starts = items.filter(i => i.name.toLowerCase().startsWith(q));
  const includes = items.filter(i => !i.name.toLowerCase().startsWith(q) && i.name.toLowerCase().includes(q));
  const matches = starts.concat(includes);

  if (matches.length === 0) { box.style.display = 'none'; return; }

  // build suggestions (include buy/sell/profit/stock/loc)
  box.innerHTML = matches.map(it => {
    const profitPer = (parseFloat(it.sell) - parseFloat(it.buy)) || 0;
    return `
      <div class="suggestItem" data-id="${it.id}" data-buy="${it.buy}" data-sell="${it.sell}" data-qty="${it.qty}" data-loc="${it.loc||''}">
        <div class="s-title">${it.name}</div>
        <div class="s-meta">Buy: ₱${parseFloat(it.buy).toFixed(2)} • Sell: ₱${parseFloat(it.sell).toFixed(2)} • Profit: ₱${profitPer.toFixed(2)} • Stock: ${it.qty} • ${it.loc || ''}</div>
      </div>
    `;
  }).join('');

  box.style.display = 'block';
}

/* -----------------------
   RENDER SALES & EXPENSES
------------------------*/
function renderSales() {
  const sales = load(LS_SALES);
  const tbody = $('sales');
  tbody.innerHTML = '';

  sales.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.date}</td>
      <td style="text-align:left">${s.item}</td>
      <td>${s.qty}</td>
      <td>₱${parseFloat(s.total).toFixed(2)}</td>
      <td>₱${parseFloat(s.profit).toFixed(2)}</td>
      <td><button class="delSale" data-id="${s.id}" style="background:#dc3545">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });

  calcReports();
}

function renderExpenses() {
  const ex = load(LS_EXP);
  const tbody = $('expenses');
  tbody && (tbody.innerHTML = '');
  if (!tbody) return;

  ex.forEach(e => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.name}</td>
      <td>${e.category}</td>
      <td>₱${parseFloat(e.amount).toFixed(2)}</td>
      <td><button class="delExp" data-id="${e.id}" style="background:#dc3545">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });

  calcReports();
}

/* -----------------------
   CALCULATIONS
------------------------*/
function calcInventory() {
  const items = load(LS_ITEMS);
  let total = 0;
  items.forEach(i => {
    total += (parseFloat(i.buy) || 0) * (parseInt(i.qty) || 0);
  });
  $('invValue').textContent = total.toFixed(2);
}

function calcReports() {
  const sales = load(LS_SALES);
  const expenses = load(LS_EXP);

  const today = new Date().toISOString().slice(0,10);
  const month = new Date().toISOString().slice(0,7);

  let salesToday = 0, salesMonth = 0, expToday = 0, expMonth = 0;

  sales.forEach(s => {
    if (s.date === today) salesToday += parseFloat(s.profit) || 0;
    if (s.date && s.date.slice(0,7) === month) salesMonth += parseFloat(s.profit) || 0;
  });

  expenses.forEach(e => {
    if (e.date === today) expToday += parseFloat(e.amount) || 0;
    if (e.date && e.date.slice(0,7) === month) expMonth += parseFloat(e.amount) || 0;
  });

  $('salesProfitToday').textContent = salesToday.toFixed(2);
  $('expensesToday').textContent = expToday.toFixed(2);
  $('netToday').textContent = (salesToday - expToday).toFixed(2);

  $('salesProfitMonth').textContent = salesMonth.toFixed(2);
  $('expensesMonth').textContent = expMonth.toFixed(2);
  $('netMonth').textContent = (salesMonth - expMonth).toFixed(2);
}

/* -----------------------
   EVENT: Search (items) input
   - show item list only when typing
   - show search details
------------------------*/
$('search').addEventListener('input', function(e) {
  const t = e.target.value;
  renderItems(t);
  showSearchDetails(t);
});

/* -----------------------
   EVENT: Sale search input (suggestions)
   - matches on first letter and includes
------------------------*/
$('saleSearch').addEventListener('input', function(e) {
  const t = e.target.value;
  showSaleSuggestions(t);
});

/* -----------------------
   CLICK HANDLER (delegate)
   handles:
     - click suggestion (sale)
     - click edit item
     - click delete item
     - click delete sale
     - click delete expense
------------------------*/
document.addEventListener('click', function(e) {
  // click sale suggestion
  const sItem = e.target.closest('.suggestItem');
  if (sItem && $('saleSuggestList')) {
    const id = sItem.dataset.id;
    const buy = sItem.dataset.buy;
    const sell = sItem.dataset.sell;
    const qty = sItem.dataset.qty;
    const loc = sItem.dataset.loc;

    $('saleItemId').value = id;
    $('saleSearch').value = sItem.querySelector('.s-title').textContent || '';
    $('saleSuggestList').style.display = 'none';
    return;
  }

  // edit item
  if (e.target.classList.contains('editItem')) {
    const id = e.target.dataset.id;
    const it = load(LS_ITEMS).find(x => x.id === id);
    if (!it) return;
    $('itemId').value = it.id;
    $('name').value = it.name;
    $('buy').value = it.buy;
    $('sell').value = it.sell;
    $('qty').value = it.qty;
    $('loc').value = it.loc;
    // scroll up to form (optional)
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }

  // delete item (restore sales stock then delete sales of item)
  if (e.target.classList.contains('delItem')) {
    if (!confirm('Delete this item? Related sales will also be removed.')) return;
    const id = e.target.dataset.id;
    let items = load(LS_ITEMS);
    let sales = load(LS_SALES);

    const item = items.find(i => i.id === id);
    if (!item) return;

    // restore stocks from its sales (optional logic; pre-delete)
    sales.forEach(s => {
      if (s.item === item.name) {
        // nothing to do if we're deleting item — but keep for logic consistency
      }
    });

    // remove sales of this item
    sales = sales.filter(s => s.item !== item.name);
    save(LS_SALES, sales);

    // remove item
    items = items.filter(i => i.id !== id);
    save(LS_ITEMS, items);

    renderItems();
    renderSales();
    calcInventory();
    calcReports();
    return;
  }

  // delete sale -> return stock
  if (e.target.classList.contains('delSale')) {
    if (!confirm('Delete this sale? Stock will be returned.')) return;
    const id = e.target.dataset.id;
    let sales = load(LS_SALES);
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    let items = load(LS_ITEMS);
    const it = items.find(i => i.name === sale.item);
    if (it) {
      it.qty = (parseInt(it.qty)||0) + (parseInt(sale.qty)||0);
      save(LS_ITEMS, items);
    }
    sales = sales.filter(s => s.id !== id);
    save(LS_SALES, sales);
    renderItems();
    renderSales();
    calcInventory();
    calcReports();
    return;
  }

  // delete expense
  if (e.target.classList.contains('delExp')) {
    if (!confirm('Delete this expense?')) return;
    const id = e.target.dataset.id;
    let ex = load(LS_EXP);
    ex = ex.filter(x => x.id !== id);
    save(LS_EXP, ex);
    renderExpenses();
    calcReports();
    return;
  }
});

/* -----------------------
   ADD / EDIT ITEM (with DUPLICATE CHECK)
------------------------*/
$('itemForm').addEventListener('submit', function(ev) {
  ev.preventDefault();

  const id = $('itemId').value || uid();
  const obj = {
    id: id,
    name: $('name').value.trim(),
    buy: parseFloat($('buy').value) || 0,
    sell: parseFloat($('sell').value) || 0,
    qty: parseInt($('qty').value) || 0,
    loc: $('loc').value.trim()
  };

  const items = load(LS_ITEMS);

  // check duplicate name (case-insensitive) but ignore when editing same item (id match)
  const nameExists = items.find(x => x.name.toLowerCase() === obj.name.toLowerCase() && x.id !== id);
  if (nameExists) {
    alert('Item name already exists! Please use a different name.');
    return;
  }

  // save/update
  const existing = items.find(x => x.id === id);
  if (existing) {
    Object.assign(existing, obj);
  } else {
    items.push(obj);
  }

  save(LS_ITEMS, items);
  $('itemForm').reset();
  $('itemId').value = '';
  renderItems();
});

/* cancel item form */
$('cancelItem').addEventListener('click', function(){ $('itemForm').reset(); $('itemId').value=''; });

/* -----------------------
   ADD SALE (uses selected suggestion)
------------------------*/
$('addSale').addEventListener('click', function() {
  const itemId = $('saleItemId').value;
  const qty = parseInt($('saleQty').value) || 0;
  const date = $('saleDate').value;

  if (!itemId) { alert('Please select an item from suggestions.'); return; }
  if (!date) { alert('Please select a date for the sale.'); return; }
  if (qty <= 0) { alert('Enter a valid quantity.'); return; }

  const items = load(LS_ITEMS);
  const it = items.find(x => x.id === itemId);
  if (!it) { alert('Selected item not found.'); return; }

  if (qty > (parseInt(it.qty)||0)) {
    if (!confirm('Quantity greater than stock. Continue?')) return;
  }

  const total = qty * parseFloat(it.sell);
  const profit = qty * (parseFloat(it.sell) - parseFloat(it.buy));

  // deduct stock
  it.qty = (parseInt(it.qty)||0) - qty;
  save(LS_ITEMS, items);

  const sales = load(LS_SALES);
  sales.push({
    id: uid(),
    item: it.name,
    qty: qty,
    date: date,
    total: total,
    profit: profit
  });
  save(LS_SALES, sales);

  // reset sale form
  $('saleItemId').value = '';
  $('saleSearch').value = '';
  $('saleQty').value = 1;
  $('saleSuggestList').style.display = 'none';

  renderItems();
  renderSales();
  calcInventory();
  calcReports();
});

/* -----------------------
   ADD EXPENSE
------------------------*/
if ($('expenseForm')) {
  $('expenseForm').addEventListener('submit', function(ev) {
    ev.preventDefault();
    const name = $('expName').value.trim();
    const amount = parseFloat($('expAmount').value) || 0;
    const category = $('expCategory').value;
    const date = $('expDate').value;
    const ex = load(LS_EXP);
    ex.push({ id: uid(), name, amount, category, date });
    save(LS_EXP, ex);
    $('expenseForm').reset();
    renderExpenses();
    calcReports();
  });
}

/* -----------------------
   INITIAL LOAD
------------------------*/
document.addEventListener('DOMContentLoaded', function() {
  // set default dates
  const today = new Date().toISOString().slice(0,10);
  if ($('saleDate')) $('saleDate').value = today;
  if ($('expDate'))  $('expDate').value = today;

  renderItems();
  renderSales();
  renderExpenses();
  calcInventory();
  calcReports();
});
  </script>
  <!-- PART 4: SALES HISTORY + BACKUP + CLEAR ALL -->

<section>
  <h2>Sales History / Filter</h2>

  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
    <div>
      <label>Single Date
        <input type="date" id="histDate">
      </label>
    </div>

    <div>
      <label>Range From
        <input type="date" id="histFrom">
      </label>
    </div>

    <div>
      <label>Range To
        <input type="date" id="histTo">
      </label>
    </div>

    <div>
      <label>Month
        <input type="month" id="histMonth">
      </label>
    </div>

    <div style="display:flex;gap:6px;align-items:flex-end;">
      <button id="histFilter">Filter</button>
      <button id="histClear" style="background:#6c757d">Clear</button>
    </div>
  </div>

  <div id="histInfo" style="display:none;padding:8px;background:#fafafa;border:1px solid #ddd;border-radius:4px;margin-bottom:8px;"></div>

  <table aria-label="History table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Item</th>
        <th>Qty</th>
        <th>Total</th>
        <th>Profit</th>
      </tr>
    </thead>
    <tbody id="histResults"></tbody>
  </table>
</section>

<hr>

<section>
  <h2>Backup & Restore</h2>

  <button id="exportBackup">Export Backup</button>
  
  <input type="file" id="importFile" style="display:none;">
  <button id="importBackup" style="background:#28a745;">Import Backup</button>

  <button id="clearAll" style="background:#dc3545;margin-left:8px;">
    Clear ALL Data
  </button>
</section>

<script>
/* -----------------------
   SALES HISTORY FILTER
------------------------*/
$('histFilter').addEventListener('click', function() {
  const sales = load(LS_SALES);

  const sd = $('histDate').value;
  const rf = $('histFrom').value;
  const rt = $('histTo').value;
  const mm = $('histMonth').value;

  let filtered = sales.slice();

  if (sd) {
    filtered = filtered.filter(s => s.date === sd);
  } else if (rf || rt) {
    if (rf) filtered = filtered.filter(s => s.date >= rf);
    if (rt) filtered = filtered.filter(s => s.date <= rt);
  } else if (mm) {
    filtered = filtered.filter(s => s.date.slice(0,7) === mm);
  }

  const body = $('histResults');
  body.innerHTML = '';

  let totSales = 0;
  let totProfit = 0;

  filtered.forEach(s => {
    totSales += parseFloat(s.total) || 0;
    totProfit += parseFloat(s.profit) || 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.date}</td>
      <td>${s.item}</td>
      <td>${s.qty}</td>
      <td>₱${parseFloat(s.total).toFixed(2)}</td>
      <td>₱${parseFloat(s.profit).toFixed(2)}</td>
    `;
    body.appendChild(tr);
  });

  const info = $('histInfo');

  if (filtered.length === 0) {
    info.style.display = 'none';
  } else {
    info.style.display = 'block';
    info.innerHTML = `
      <b>Total Sales:</b> ₱${totSales.toFixed(2)}<br>
      <b>Total Profit:</b> ₱${totProfit.toFixed(2)}<br>
      <b>Records:</b> ${filtered.length}
    `;
  }
});

/* CLEAR HISTORY FILTER */
$('histClear').addEventListener('click', function() {
  $('histDate').value = '';
  $('histFrom').value = '';
  $('histTo').value = '';
  $('histMonth').value = '';

  $('histResults').innerHTML = '';
  $('histInfo').style.display = 'none';
});

/* -----------------------
   EXPORT BACKUP (Items + Sales + Expenses)
------------------------*/
$('exportBackup').addEventListener('click', function() {
  const data = {
    items: load(LS_ITEMS),
    sales: load(LS_SALES),
    expenses: load(LS_EXP),
    exportedAt: new Date().toISOString()
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'pos_backup_' + Date.now() + '.json';
  a.click();
});

/* -----------------------
   IMPORT BACKUP
------------------------*/
$('importBackup').addEventListener('click', function() {
  $('importFile').click();
});

$('importFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function() {
    try {
      const data = JSON.parse(reader.result);

      save(LS_ITEMS, data.items || []);
      save(LS_SALES, data.sales || []);
      save(LS_EXP, data.expenses || []);

      alert('Backup imported successfully!');
      renderItems();
      renderSales();
      renderExpenses();
      calcReports();
      calcInventory();

    } catch (err) {
      alert('Invalid backup file.');
    }
  };

  reader.readAsText(file);
});

/* -----------------------
   CLEAR ALL DATA
------------------------*/
$('clearAll').addEventListener('click', function() {
  if (!confirm('Delete ALL data?')) return;

  localStorage.removeItem(LS_ITEMS);
  localStorage.removeItem(LS_SALES);
  localStorage.removeItem(LS_EXP);

  renderItems();
  renderSales();
  renderExpenses();
  calcReports();
  calcInventory();
});
  /* -----------------------
   FINAL INITIAL LOAD
------------------------*/
document.addEventListener('DOMContentLoaded', function() {
  // Default today date
  const today = new Date().toISOString().slice(0,10);
  if ($('saleDate')) $('saleDate').value = today;
  if ($('expDate'))  $('expDate').value  = today;

  renderItems();
  renderSales();
  renderExpenses();
  calcInventory();
  calcReports();
});
</script>

</body>
</html>
