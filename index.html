<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Makoi Motor Shop POS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #f5f5f5;
      color: #222;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    header .date-time {
      font-size: 13px;
      color: #666;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .card h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    .card small {
      color: #777;
      font-size: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .stat-box {
      background: #f5f7fb;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
    }
    .stat-box .label {
      color: #555;
      margin-bottom: 4px;
    }
    .stat-box .value {
      font-weight: 600;
      font-size: 15px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.2);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: #1a73e8;
      color: #fff;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #222;
    }
    .btn-danger {
      background: #e53935;
      color: #fff;
    }
    .pill-toggle {
      display: inline-flex;
      background: #e9e9e9;
      border-radius: 999px;
      padding: 3px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .pill-toggle button {
      flex: 1;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: transparent;
      color: #555;
      box-shadow: none;
    }
    .pill-toggle button.active {
      background: #ffffff;
      color: #1a73e8;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      font-weight: 600;
      color: #555;
    }
    td.actions {
      text-align: right;
    }
    .link-btn {
      background: none;
      border: none;
      color: #1a73e8;
      font-size: 12px;
      padding: 0;
      cursor: pointer;
    }
    .footer-note {
      font-size: 11px;
      color: #777;
      margin-top: 8px;
      line-height: 1.4;
    }
    @media (max-width: 600px) {
      .app {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Makoi Motor Shop POS</h1>
      <div class="date-time" id="headerDate"></div>
    </header>

    <!-- 1. ITEMS SECTION (ADD / EDIT) -->
    <section class="card">
      <h2>Items / Inventory</h2>
      <small>Magdagdag o mag-edit ng item. Kapag same ang name, maa-update lang (hindi dodoble).</small>

      <div class="row">
        <div>
          <label for="itemName">Item name</label>
          <input id="itemName" type="text" placeholder="Hal. brake pad" />
        </div>
        <div>
          <label for="itemQty">Quantity (stock)</label>
          <input id="itemQty" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="itemBuy">Buying price (per pc)</label>
          <input id="itemBuy" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label for="itemSell">Selling price (per pc)</label>
          <input id="itemSell" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="itemStorage">Storage</label>
          <input id="itemStorage" type="text" placeholder="Hal. Cabinet A, Box 1" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="btnSaveItem">Save item</button>
        <button class="btn-secondary" id="btnResetItem">Reset</button>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="stat-box">
          <div class="label">Total items</div>
          <div class="value" id="statTotalItems">0</div>
          <div class="label">Unique item names</div>
        </div>
        <div class="stat-box">
          <div class="label">Inventory cost (buy)</div>
          <div class="value" id="statInvCost">â‚±0.00</div>
          <div class="label">Sum of buy Ã— stock</div>
        </div>
        <div class="stat-box">
          <div class="label">Inventory value (sell)</div>
          <div class="value" id="statInvSell">â‚±0.00</div>
          <div class="label">Sum of sell Ã— stock</div>
        </div>
      </div>
    </section>

    <!-- 2. SEARCH SECTION -->
    <section class="card">
      <h2>Search item</h2>
      <small>Hanapin ang item. Lalabas ang buying price, selling price, profit at storage.</small>

      <div class="row">
        <div>
          <label for="searchInput">Search</label>
          <input id="searchInput" type="text" placeholder="Type item name or storage..." />
        </div>
      </div>

      <table id="searchTable">
        <thead>
          <tr>
            <th>Item</th>
            <th>Buy</th>
            <th>Sell</th>
            <th>Profit/pc</th>
            <th>Stock</th>
            <th>Storage</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 3. SALES & PROFIT SECTION -->
    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <div>
          <h2>Sales &amp; Profit</h2>
          <small>Record sales, auto profit &amp; daily / all-time summary.</small>
        </div>
        <div>
          <label for="saleDate">Date</label>
          <input id="saleDate" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="saleItemName">Select / search item</label>
          <input id="saleItemName" list="itemsDatalist" placeholder="Type item name..." />
          <datalist id="itemsDatalist"></datalist>
        </div>
        <div>
          <label for="saleQty">Quantity (pcs)</label>
          <input id="saleQty" type="number" min="1" value="1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="saleSell">Selling price (per pc)</label>
          <input id="saleSell" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label for="saleBuy">Buying price (per pc)</label>
          <input id="saleBuy" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="saleTotal">Total amount</label>
          <input id="saleTotal" type="number" readonly />
        </div>
        <div>
          <label for="saleProfit">Profit for this sale</label>
          <input id="saleProfit" type="number" readonly />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="btnSaveSale">âœ… Save sale</button>
        <button class="btn-secondary" id="btnResetSale">âŸ³ Reset sale</button>
        <button class="btn-danger" id="btnClearSales">ðŸ—‘ Clear all sales</button>
      </div>

      <div class="pill-toggle">
        <button id="tabToday" class="active">Today</button>
        <button id="tabAllTime">All time</button>
      </div>

      <div class="grid">
        <div class="stat-box">
          <div class="label" id="salesLabel">Today sales</div>
          <div class="value" id="statSalesAmount">â‚±0.00</div>
          <div class="label">Total amount of sales</div>
        </div>
        <div class="stat-box">
          <div class="label" id="profitLabel">Today profit</div>
          <div class="value" id="statSalesProfit">â‚±0.00</div>
          <div class="label">Sales â€“ cost (buy)</div>
        </div>
        <div class="stat-box">
          <div class="label" id="expLabel">Recorded expenses</div>
          <div class="value" id="statExpenses">â‚±0.00</div>
          <div class="label">For net profit computation</div>
        </div>
        <div class="stat-box">
          <div class="label" id="netLabel">Net profit</div>
          <div class="value" id="statNetProfit">â‚±0.00</div>
          <div class="label">Profit â€“ expenses</div>
        </div>
      </div>

      <h3 style="margin-top:12px; font-size:14px;">Recent sales</h3>
      <button class="link-btn" id="btnReloadToday">Use today date</button>
      <table id="salesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Total</th>
            <th>Profit</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 4. EXPENSES -->
    <section class="card">
      <h2>Expenses</h2>
      <small>Automatic na binabawas sa profit ng sales (net profit).</small>

      <div class="row" style="margin-top:8px;">
        <div>
          <label for="expDesc">Description</label>
          <input id="expDesc" type="text" placeholder="e.g. kuryente, renta, sweldo" />
        </div>
        <div>
          <label for="expAmount">Amount</label>
          <input id="expAmount" type="number" min="0" step="0.01" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="expDate">Date</label>
          <input id="expDate" type="date" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="btnSaveExpense">ðŸ’µ Save expense</button>
        <button class="btn-secondary" id="btnResetExpense">Reset</button>
        <button class="btn-danger" id="btnClearExpenses">ðŸ—‘ Clear all expenses</button>
      </div>

      <table id="expensesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- 5. BACKUP SECTION -->
    <section class="card">
      <h2>Backup &amp; Restore</h2>
      <small>Para hindi mawala ang data mo.</small>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn-primary" id="btnExport">â¬‡ Export backup (JSON)</button>
        <label class="btn-secondary" style="cursor:pointer;">
          â¬† Import backup
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </label>
      </div>
      <div class="footer-note">
        Lahat ng data naka-save sa browser ng device na gamit mo. Kapag nagbago ka
        ng phone / nag-clear ng data, mawawala rin (pero pwede mong i-restore gamit
        ang na-export na backup file).
      </div>
    </section>
  </div>

  <script>
    const STORAGE_KEY = "makoi_motor_shop_pos_v1";

    let state = {
      items: [],
      sales: [],
      expenses: []
    };

    // Utility
    function formatMoney(num) {
      if (isNaN(num)) num = 0;
      return "â‚±" + Number(num).toFixed(2);
    }

    function todayStr() {
      return new Date().toISOString().slice(0, 10);
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          state = Object.assign({ items: [], sales: [], expenses: [] }, parsed);
        } catch (e) {
          console.error("Failed to parse storage", e);
        }
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // DOM refs
    const headerDate = document.getElementById("headerDate");

    const itemName = document.getElementById("itemName");
    const itemQty = document.getElementById("itemQty");
    const itemBuy = document.getElementById("itemBuy");
    const itemSell = document.getElementById("itemSell");
    const itemStorage = document.getElementById("itemStorage");
    const statTotalItems = document.getElementById("statTotalItems");
    const statInvCost = document.getElementById("statInvCost");
    const statInvSell = document.getElementById("statInvSell");
    const btnSaveItem = document.getElementById("btnSaveItem");
    const btnResetItem = document.getElementById("btnResetItem");

    const searchInput = document.getElementById("searchInput");
    const searchTableBody = document.querySelector("#searchTable tbody");

    const saleDate = document.getElementById("saleDate");
    const saleItemName = document.getElementById("saleItemName");
    const saleQty = document.getElementById("saleQty");
    const saleSell = document.getElementById("saleSell");
    const saleBuy = document.getElementById("saleBuy");
    const saleTotal = document.getElementById("saleTotal");
    const saleProfit = document.getElementById("saleProfit");
    const btnSaveSale = document.getElementById("btnSaveSale");
    const btnResetSale = document.getElementById("btnResetSale");
    const btnClearSales = document.getElementById("btnClearSales");
    const btnReloadToday = document.getElementById("btnReloadToday");
    const itemsDatalist = document.getElementById("itemsDatalist");
    const salesTableBody = document.querySelector("#salesTable tbody");

    const tabToday = document.getElementById("tabToday");
    const tabAllTime = document.getElementById("tabAllTime");
    const statSalesAmount = document.getElementById("statSalesAmount");
    const statSalesProfit = document.getElementById("statSalesProfit");
    const statExpenses = document.getElementById("statExpenses");
    const statNetProfit = document.getElementById("statNetProfit");
    const salesLabel = document.getElementById("salesLabel");
    const profitLabel = document.getElementById("profitLabel");
    const expLabel = document.getElementById("expLabel");
    const netLabel = document.getElementById("netLabel");

    const expDesc = document.getElementById("expDesc");
    const expAmount = document.getElementById("expAmount");
    const expDate = document.getElementById("expDate");
    const btnSaveExpense = document.getElementById("btnSaveExpense");
    const btnResetExpense = document.getElementById("btnResetExpense");
    const btnClearExpenses = document.getElementById("btnClearExpenses");
    const expensesTableBody = document.querySelector("#expensesTable tbody");

    const btnExport = document.getElementById("btnExport");
    const importFile = document.getElementById("importFile");

    let summaryMode = "today"; // 'today' or 'all'

    // HEADER DATE
    function renderHeaderDate() {
      const now = new Date();
      const opts = { month: "short", day: "numeric", year: "numeric" };
      const dateStr = now.toLocaleDateString(undefined, opts);
      const timeStr = now.toLocaleTimeString(undefined, {
        hour: "numeric",
        minute: "2-digit"
      });
      headerDate.textContent = dateStr + " â€¢ " + timeStr;
    }

    // ITEMS
    function renderInventoryStats() {
      const totalItems = state.items.length;
      let invCost = 0;
      let invSell = 0;
      state.items.forEach((it) => {
        const qty = Number(it.qty) || 0;
        invCost += qty * (Number(it.buy) || 0);
        invSell += qty * (Number(it.sell) || 0);
      });
      statTotalItems.textContent = String(totalItems);
      statInvCost.textContent = formatMoney(invCost);
      statInvSell.textContent = formatMoney(invSell);
    }

    function clearItemForm() {
      itemName.value = "";
      itemQty.value = "0";
      itemBuy.value = "";
      itemSell.value = "";
      itemStorage.value = "";
    }

    function upsertItem() {
      const name = itemName.value.trim();
      if (!name) {
        alert("Item name is required.");
        return;
      }
      const qty = Number(itemQty.value) || 0;
      const buy = Number(itemBuy.value) || 0;
      const sell = Number(itemSell.value) || 0;
      const storage = itemStorage.value.trim();

      const existing = state.items.find(
        (it) => it.name.toLowerCase() === name.toLowerCase()
      );
      if (existing) {
        // edit
        existing.qty = qty;
        existing.buy = buy;
        existing.sell = sell;
        existing.storage = storage;
      } else {
        state.items.push({
          id: Date.now(),
          name,
          qty,
          buy,
          sell,
          storage
        });
      }
      saveState();
      renderAll();
      clearItemForm();
    }

    // SEARCH
    function renderSearchResults() {
      const q = searchInput.value.trim().toLowerCase();
      const rows = state.items.filter((it) => {
        if (!q) return true;
        return (
          it.name.toLowerCase().includes(q) ||
          (it.storage || "").toLowerCase().includes(q)
        );
      });

      searchTableBody.innerHTML = "";
      rows.forEach((it) => {
        const tr = document.createElement("tr");
        const profitPerPc = (Number(it.sell) || 0) - (Number(it.buy) || 0);
        tr.innerHTML = `
          <td>${it.name}</td>
          <td>${formatMoney(it.buy)}</td>
          <td>${formatMoney(it.sell)}</td>
          <td>${formatMoney(profitPerPc)}</td>
          <td>${it.qty}</td>
          <td>${it.storage || ""}</td>
        `;
        searchTableBody.appendChild(tr);
      });
    }

    function populateItemsDatalist() {
      itemsDatalist.innerHTML = "";
      state.items.forEach((it) => {
        const opt = document.createElement("option");
        opt.value = it.name;
        itemsDatalist.appendChild(opt);
      });
    }

    // SALES
    function updateSaleComputed() {
      const qty = Number(saleQty.value) || 0;
      const sell = Number(saleSell.value) || 0;
      const buy = Number(saleBuy.value) || 0;
      const total = qty * sell;
      const profit = qty * (sell - buy);
      saleTotal.value = total ? total.toFixed(2) : "";
      saleProfit.value = profit ? profit.toFixed(2) : "";
    }

    function onSaleItemSelected() {
      const name = saleItemName.value.trim();
      const it = state.items.find(
        (x) => x.name.toLowerCase() === name.toLowerCase()
      );
      if (it) {
        saleSell.value = it.sell;
        saleBuy.value = it.buy;
      }
      updateSaleComputed();
    }

    function clearSaleForm() {
      saleItemName.value = "";
      saleQty.value = "1";
      saleSell.value = "";
      saleBuy.value = "";
      saleTotal.value = "";
      saleProfit.value = "";
    }

    function saveSale() {
      const name = saleItemName.value.trim();
      if (!name) {
        alert("Please choose item.");
        return;
      }
      const item = state.items.find(
        (it) => it.name.toLowerCase() === name.toLowerCase()
      );
      if (!item) {
        alert("Item not found in inventory.");
        return;
      }
      const qty = Number(saleQty.value) || 0;
      if (qty <= 0) {
        alert("Quantity must be greater than 0.");
        return;
      }
      if (qty > item.qty) {
        if (
          !confirm(
            "Stock is lower than quantity. Proceed anyway? (stock will become negative)"
          )
        ) {
          return;
        }
      }
      const sell = Number(saleSell.value) || 0;
      const buy = Number(saleBuy.value) || 0;
      const total = qty * sell;
      const profit = qty * (sell - buy);
      const date = saleDate.value || todayStr();

      const sale = {
        id: Date.now(),
        date,
        itemName: name,
        qty,
        sell,
        buy,
        total,
        profit
      };
      state.sales.push(sale);

      // deduct from stock
      item.qty = (Number(item.qty) || 0) - qty;

      saveState();
      renderAll();
      clearSaleForm();
    }

    function deleteSale(id) {
      const idx = state.sales.findIndex((s) => s.id === id);
      if (idx === -1) return;
      const sale = state.sales[idx];
      const item = state.items.find(
        (it) => it.name.toLowerCase() === sale.itemName.toLowerCase()
      );
      if (item) {
        item.qty = (Number(item.qty) || 0) + Number(sale.qty || 0);
      }
      state.sales.splice(idx, 1);
      saveState();
      renderAll();
    }

    function renderSalesTable() {
      const filterDate = summaryMode === "today" ? saleDate.value || todayStr() : null;
      salesTableBody.innerHTML = "";
      const rows = state.sales.filter((s) =>
        filterDate ? s.date === filterDate : true
      );
      rows
        .slice()
        .sort((a, b) => b.id - a.id)
        .forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.date}</td>
            <td>${s.itemName}</td>
            <td>${s.qty}</td>
            <td>${formatMoney(s.total)}</td>
            <td>${formatMoney(s.profit)}</td>
            <td class="actions">
              <button class="link-btn" data-id="${s.id}">Delete</button>
            </td>
          `;
          salesTableBody.appendChild(tr);
        });

      // attach handlers
      salesTableBody.querySelectorAll("button[data-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (confirm("Are you sure?")) {
            deleteSale(Number(btn.getAttribute("data-id")));
          }
        });
      });
    }

    function renderSalesSummary() {
      const filterDate = summaryMode === "today" ? saleDate.value || todayStr() : null;

      let sumSales = 0;
      let sumProfit = 0;
      state.sales.forEach((s) => {
        if (!filterDate || s.date === filterDate) {
          sumSales += Number(s.total) || 0;
          sumProfit += Number(s.profit) || 0;
        }
      });

      let sumExpenses = 0;
      state.expenses.forEach((e) => {
        if (!filterDate || e.date === filterDate) {
          sumExpenses += Number(e.amount) || 0;
        }
      });

      statSalesAmount.textContent = formatMoney(sumSales);
      statSalesProfit.textContent = formatMoney(sumProfit);
      statExpenses.textContent = formatMoney(sumExpenses);
      statNetProfit.textContent = formatMoney(sumProfit - sumExpenses);

      if (summaryMode === "today") {
        salesLabel.textContent = "Today sales";
        profitLabel.textContent = "Today profit";
        expLabel.textContent = "Today expenses";
        netLabel.textContent = "Today net profit";
      } else {
        salesLabel.textContent = "All time sales";
        profitLabel.textContent = "All time profit";
        expLabel.textContent = "All time expenses";
        netLabel.textContent = "All time net profit";
      }
    }

    // EXPENSES
    function clearExpenseForm() {
      expDesc.value = "";
      expAmount.value = "";
    }

    function saveExpense() {
      const desc = expDesc.value.trim();
      const amount = Number(expAmount.value) || 0;
      const date = expDate.value || todayStr();
      if (!desc) {
        alert("Description is required.");
        return;
      }
      if (amount <= 0) {
        alert("Amount must be greater than 0.");
        return;
      }
      state.expenses.push({
        id: Date.now(),
        date,
        desc,
        amount
      });
      saveState();
      renderAll();
      clearExpenseForm();
    }

    function deleteExpense(id) {
      const idx = state.expenses.findIndex((e) => e.id === id);
      if (idx === -1) return;
      state.expenses.splice(idx, 1);
      saveState();
      renderAll();
    }

    function renderExpensesTable() {
      expensesTableBody.innerHTML = "";
      state.expenses
        .slice()
        .sort((a, b) => b.id - a.id)
        .forEach((e) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.date}</td>
            <td>${e.desc}</td>
            <td>${formatMoney(e.amount)}</td>
            <td class="actions">
              <button class="link-btn" data-id="${e.id}">Delete</button>
            </td>
          `;
          expensesTableBody.appendChild(tr);
        });

      expensesTableBody.querySelectorAll("button[data-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (confirm("Are you sure?")) {
            deleteExpense(Number(btn.getAttribute("data-id")));
          }
        });
      });
    }

    // BACKUP
    function exportBackup() {
      const blob = new Blob([JSON.stringify(state, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const d = new Date();
      const stamp = d.toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = `makoi-motor-shop-backup-${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importBackup(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data || typeof data !== "object") {
            throw new Error("Invalid file");
          }
          if (!confirm("Are you sure? (Current data will be replaced)")) {
            return;
          }
          state = Object.assign({ items: [], sales: [], expenses: [] }, data);
          saveState();
          renderAll();
          alert("Backup restored.");
        } catch (err) {
          alert("Invalid backup file.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    // RENDER ALL
    function renderAll() {
      renderHeaderDate();
      renderInventoryStats();
      renderSearchResults();
      populateItemsDatalist();
      renderSalesTable();
      renderSalesSummary();
      renderExpensesTable();
    }

    // EVENTS
    btnSaveItem.addEventListener("click", upsertItem);
    btnResetItem.addEventListener("click", () => {
      if (confirm("Are you sure?")) clearItemForm();
    });

    searchInput.addEventListener("input", renderSearchResults);

    saleItemName.addEventListener("change", onSaleItemSelected);
    saleItemName.addEventListener("input", onSaleItemSelected);
    saleQty.addEventListener("input", updateSaleComputed);
    saleSell.addEventListener("input", updateSaleComputed);
    saleBuy.addEventListener("input", updateSaleComputed);

    btnSaveSale.addEventListener("click", saveSale);
    btnResetSale.addEventListener("click", () => {
      if (confirm("Are you sure?")) clearSaleForm();
    });
    btnClearSales.addEventListener("click", () => {
      if (!state.sales.length) return;
      if (confirm("Are you sure?")) {
        // rollback stocks
        state.sales.forEach((s) => {
          const item = state.items.find(
            (it) => it.name.toLowerCase() === s.itemName.toLowerCase()
          );
          if (item) {
            item.qty = (Number(item.qty) || 0) + Number(s.qty || 0);
          }
        });
        state.sales = [];
        saveState();
        renderAll();
      }
    });

    btnReloadToday.addEventListener("click", () => {
      saleDate.value = todayStr();
      summaryMode = "today";
      tabToday.classList.add("active");
      tabAllTime.classList.remove("active");
      renderSalesTable();
      renderSalesSummary();
    });

    tabToday.addEventListener("click", () => {
      summaryMode = "today";
      tabToday.classList.add("active");
      tabAllTime.classList.remove("active");
      renderSalesTable();
      renderSalesSummary();
    });

    tabAllTime.addEventListener("click", () => {
      summaryMode = "all";
      tabAllTime.classList.add("active");
      tabToday.classList.remove("active");
      renderSalesTable();
      renderSalesSummary();
    });

    saleDate.addEventListener("change", () => {
      if (summaryMode === "today") {
        renderSalesTable();
        renderSalesSummary();
      }
    });

    btnSaveExpense.addEventListener("click", saveExpense);
    btnResetExpense.addEventListener("click", () => {
      if (confirm("Are you sure?")) clearExpenseForm();
    });
    btnClearExpenses.addEventListener("click", () => {
      if (!state.expenses.length) return;
      if (confirm("Are you sure?")) {
        state.expenses = [];
        saveState();
        renderAll();
      }
    });

    btnExport.addEventListener("click", exportBackup);
    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) importBackup(file);
      e.target.value = "";
    });

    // INIT
    loadState();
    saleDate.value = todayStr();
    expDate.value = todayStr();
    renderAll();

    // Update header time every minute (optional)
    setInterval(renderHeaderDate, 60000);
  </script>
</body>
</html>
